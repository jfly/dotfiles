#!/usr/bin/env bash

set -euo pipefail

cd "$(dirname "$0")"

function get_terminal_pid() {
    local terminal_pid

    # First search for an ancestor terminal process.
    terminal_pid=$(pstree -spl $$ | grep -Eo 'alacritty\([0-9]+\)' | grep -o '[0-9]*' | tail -1)

    # If there isn't an ancestor terminal process, then look at the currently
    # focused window, but make sure it's a terminal process and not some poor
    # other process.
    if [ -z "$terminal_pid" ]; then
        terminal_pid=$(xdotool getwindowpid "$(xdotool getwindowfocus)")
        exe_name=$(basename "$(readlink "/proc/${terminal_pid}/exe")")
        if [ "$exe_name" != "alacritty" ]; then
            echo "The currently focused window is: '${exe_name}', but I expected 'alacritty'"
            exit 1
        fi
    fi

    echo "$terminal_pid"
}

function get_json_colorscheme() {
    local colorscheme=$1
    yq <"colorschemes/$colorscheme.yaml"
}

function get_available_colorschemes() {
    for f in colorschemes/*.yaml; do
        f="$(basename "$f")"
        echo "${f%.yaml}"
    done
}
colorschemes="$(get_available_colorschemes)"

# From http://stackoverflow.com/a/8064551
listcontains() {
    for word in $1; do
        [[ $word == "$2" ]] && return 0
    done
    return 1
}

# Validate command line arguments
print_usage_and_exit() {
    echo "Usage: $0 [current|global] [colorscheme]"
    echo ""
    echo "Where colorscheme is one of:"
    echo "$colorschemes"
    exit 1
}
if [ $# -ne 2 ]; then
    print_usage_and_exit
fi

location=$1
shift

colorscheme=$1
shift
if ! listcontains "$colorschemes" "$colorscheme"; then
    echo "Unrecognized colorscheme: $colorscheme"
    print_usage_and_exit
fi

if [ "$location" = "current" ]; then
    location=$(get_terminal_pid)
elif [ "$location" = "global" ]; then
    location="global"
else
    echo "Unrecognized location: $location"
fi

with-alacritty set "$location" "{\"colors\": $(get_json_colorscheme "$colorscheme")}"
