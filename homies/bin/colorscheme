#!/usr/bin/env bash

set -euo pipefail
shopt -s globstar # enable ** glob expansion

cd "$(dirname "$0")"

function _get_terminal_pid() {
    local terminal_pid

    terminal_pid=""
    # First search for an ancestor terminal process.
    terminal_pid=$(pstree -spl $$ | grep -Eo 'alacritty\([0-9]+\)' | grep -o '[0-9]*' | tail -1)

    # If there isn't an ancestor terminal process, then look at the currently
    # focused window, but make sure it's a terminal process and not some poor
    # other process.
    if [ -z "$terminal_pid" ]; then
        terminal_pid=$(xdotool getwindowpid "$(xdotool getwindowfocus)")
        exe_name=$(basename "$(readlink "/proc/${terminal_pid}/exe")")
        if [ "$exe_name" != "alacritty" ]; then
            echo "The currently focused window is: '${exe_name}', but I expected 'alacritty'"
            exit 1
        fi
    fi

    echo "$terminal_pid"
}

function _get_location() {
    local location=$1
    if [ "$location" = "current" ]; then
        _get_terminal_pid
    else
        echo "$location"
    fi
}

function _get_json_colorscheme() {
    local colorscheme=$1
    local file
    file=$(ls ~/.dotfiles/colorschemes/**/"$colorscheme.yml" 2>/dev/null)
    yq .colors "$file"
}

# Validate command line arguments
function _print_usage_and_exit() {
    local name
    name=$(basename "$0")
    echo "## Usage"
    echo ""
    echo "    $name set [current|global|PID] [colorscheme]"
    echo "    $name clear [current|global|PID]"
    echo "    $name list"
    echo ""
    echo "## Examples"
    echo ""
    echo "### Set the colorscheme for the current terminal"
    echo ""
    echo "    $name current light"
    echo ""
    echo "### Reset the colorscheme for the current terminal to the global default"
    echo ""
    echo "    $name clear-current"
    echo ""
    echo "### Get a list of available colorschemes"
    echo ""
    echo "    $name list"
    exit 1
}

function _list() {
    for f in ~/.dotfiles/colorschemes/**/*.yml; do
        f="$(basename "$f")"
        echo "${f%.yml}"
    done
}

function _set() {
    if [ $# -ne 2 ]; then
        _print_usage_and_exit
    fi

    local location=$1
    local colorscheme=$2

    with-alacritty set "$(_get_location "$location")" colors "$(_get_json_colorscheme "$colorscheme")"
}

function _clear() {
    if [ $# -ne 1 ]; then
        _print_usage_and_exit
    fi

    local location=$1

    with-alacritty clear "$(_get_location "$location")" colors
}

if [ $# -eq 0 ]; then
    _print_usage_and_exit
fi

subcommand_pretty=$1
subcommand=_"$subcommand_pretty"
shift

if [[ $(type -t "$subcommand") == function ]]; then
    $subcommand "$@"
else
    echo "Unrecognized subcommand: $subcommand_pretty"
    exit 1
fi
